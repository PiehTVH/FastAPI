<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="htmx-config" content='{"refreshOnHistoryMiss":"true"}'>
    <link rel="stylesheet" href="{{ url_for('static', path='css/menu.css') }}">
    <!-- <link href="{{ url_for('static', path='/css/app.css') }}" rel="stylesheet"> -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/2.1.0/uicons-bold-rounded/css/uicons-bold-rounded.css'>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300&display=swap" rel="stylesheet">
    <link rel='stylesheet'
        href='https://cdn-uicons.flaticon.com/2.1.0/uicons-regular-straight/css/uicons-regular-straight.css'>
    <link rel='stylesheet'
        href='https://cdn-uicons.flaticon.com/2.1.0/uicons-regular-rounded/css/uicons-regular-rounded.css'>
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/2.1.0/uicons-bold-rounded/css/uicons-bold-rounded.css'>
    <link rel='stylesheet'
        href='https://cdn-uicons.flaticon.com/2.1.0/uicons-solid-straight/css/uicons-solid-straight.css'>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300&display=swap" rel="stylesheet">
    <script src="{{ url_for('static', path='js/scripts.js') }}"></script>
    <script src="{{ url_for('static', path='js/htmx.min.js') }}"></script>
    <script src="{{ url_for('static', path='js/json-enc.js') }}"></script>
    <script src="{{ url_for('static', path='js/class-tools.js') }}"></script>
    <script src="{{ url_for('static', path='js/ws.js') }}"></script>
    <!-- <script src="https://unpkg.com/htmx.org/dist/ext/class-tools.js"></script> -->
    <!-- <script src="https://unpkg.com/htmx.org/dist/ext/ws.js"></script> -->
    <!-- <script src="https://unpkg.com/htmx.org@1.9.10"
        integrity="sha384-D1Kt99CQMDuVetoL1lrYwg5t+9QdHe7NLX/SoJYkXDFfX37iInKRy5xLSi8nO7UC"
        crossorigin="anonymous"></script> -->
    <!-- <script src="https://unpkg.com/idiomorph/dist/idiomorph-ext.min.js"></script> -->
    <!-- <script src="https://unpkg.com/htmx.org/dist/ext/json-enc.js"></script> -->

    
    

    <title>ONBOOK</title>
    <style>
        #history p {
            border: solid 1px;
            border-radius: 5px;
            width:120px;
            height: auto;
            margin: 5px;
            margin-left: auto;
            word-wrap:break-word;
            padding:5px;
            box-shadow: 0 0 2px gray;
            background-color: aliceblue;
            
        }

        #history h4 {
            border: solid 1px;
            border-radius: 5px;
            width:120px;
            height: auto;
            margin: 5px;
            margin-right: auto;
            word-wrap: break-word;
            font-weight: lighter;
            padding:5px;
            text-align: right;
            box-shadow: 0 0 2px gray;
            background-color:bisque;
            
        }
    </style>
</head>

<body id="main" >
    <div id="nav_box">
        <div class="inisible" hx-post="/auth/refresh" hx-swap="none" hx-trigger="load" hx-on::after-request="refresh_nav()"></div>
        <nav id="nav" class="nav">
            <span class="logo" hx-get="/pages/banners" 
            hx-swap="innerHTML transition:true"
            hx-target="#bookings_list"
            >ONBOOK</span>
            <div class="wrapper">
                <div class="tabs">
                    <input type="radio" name="tabs" checked id="tab1">
                    <label class="nav_lab" for="tab1" hx-get="/pages/search" hx-target="#bookings_list"
                        hx-swap="innerHTML transition:true" 
                        hx-push-url="true">Поиск отелей</label>
                    <input type="radio" name="tabs" checked id="tab2">
                    <label class="nav_lab" for="tab2" hx-get="/pages/anon_fav" hx-target="#bookings_list" 
                    hx-push-url="true" >
                        <div><i class="fi fi-rs-heart"></i><sup class="sup">{{fav_count}}</sup></div>
                    </label>
                    <input type="radio" name="tabs" checked id="tab3">
                    <label class="nav_lab" for="tab3" hx-get="/pages/cart/anon" hx-target="#bookings_list"
                        hx-swap="innerHTML transition:true"  hx-push-url="true">
                        <div>
                            <i class="fi fi-rr-shopping-cart" id="cart"></i><sup class="sup">{{cart_count}}</sup>
                        </div>
                    </label>
                    <input type="radio" name="tabs" checked id="tab4">
                    <label class="nav_lab" for="tab4" hx-get="/pages/login" hx-target="#login_bar"
                        hx-swap="innerHTML transition:true" 
                        hx-push-url="true"
                        >Войти</label>
                    <div class="glider"></div>
                </div>
            </div>
        </nav>
    </div>

    <div id="login_bar" class="login_bar"></div>
    <div id="bookings_list" class="bookings_list" hx-swap="outerHTML transition:true"><span></span></div>
    
    
        <div class="service" hx-ext="ws" ws-connect="/chat/wsock/1">
            <div class="serv_name" onclick="showChat()"><span class="sp"><i
                class=
                "fi fi-rs-comment-alt"
                ></i></span></div>
            <div class="chat" id="chat">
                <i class="fi fi-rr-angle-small-down" onclick="hiddenChat()"></i>
                <div class="chat_field" id="history">  
            </div>
                <form id="form" ws-send=""> 
                <div class="input_box">
                <input class="chat_input" type="text" id="chat_message" name="chat_message">
                <button class="button_chat" type="submit"><i class="fi fi-rr-arrow-right" ></i></button>
            </div></form>
            </div>
        </div>
        <footer class="footer">
        <div class="footer__top">
            <div class="footer__left">
                <div class="logo_1">ONBOOK</div>
                <div class="text">Simple booking</div>
            </div>
            <div class="footer__right">
                <div class="contact">Как с нами связаться:</div>
                <div class="phone"><label></label>+7 (800) 800-20-20</label></div>
                <div class="address"><label>Екатеринбург, ул.Московская, д.3</label></div>
            </div>
        </div>
        <div class="footer__bottom">ONBOOK All rights reserved.</div>
    </footer>
  
    <dialog class="dial" id="dial">
        <div class="dial_box">
        <form method="dialog">
        <button autofocus value="true" class="dial_button">Ok</button>
        <button class="dial_button1" value="false">Отмена</button>
        </form>
        <div class="dial_mess"><p  id="dial_mess"></p></div>
        </div>
    </dialog>

 
    <dialog class="popup" id="popup">
        <div class="popup_box">
            <button  class="popup_button"><i
                class=
                "fi fi-br-cross"
                ></i></button>
            <div class="popup_mess"><p  id="popup_mess"></p></div>
        </div>
    </dialog>

    <script>
        // client_id = Date.now()
        // ws = new WebSocket(`ws://localhost:8000/chat/ws/${client_id}`);

        // ws.onmessage = function(event) {
        //     let messages = document.getElementById('chat_field')
        //     let message = document.createElement('li')
        //     let mes_content = document.createElement('div')
        //     let content = document.createTextNode(event.data)
        //     mes_content.appendChild(content)
        //     message.appendChild(mes_content)
        //     messages.appendChild(message)
        //     let chat = document.getElementById('history')
        //     chat.scrollTop = chat.scrollHeight
            
        // };
        // function sendMessage(event) {
        //     var input = document.getElementById("chat_message")
        //     ws.send(input.value)
        //     input.value = ''
        //     event.preventDefault()
        // }
        popup = document.getElementById("popup");
        popup_box = document.querySelector(".popup_box");
        popup_msgs = document.getElementById("popup_mess");
        popup_button = document.querySelector(".popup_button");
        dlg = document.getElementById("dial");
        clsBtn = document.querySelector(".dial_button");
        clsBtnNo = document.querySelector(".dial_button1");
        msgs = document.getElementById("dial_mess");
        // msg.textContent = "";
        function showMdAlrt(msg) {
            toggleTwoClasses(dlg, "is-visible", "is-hidden", 500);
            msgs.textContent = msg;
            dlg.showModal();
            // window.history.pushState(null, null, document.location);
            show = true;
            
        }

        
        function toggleTwoClasses(element, first, second, timeOfAnimation) {
            if (!element.classList.contains(first)) {
                element.classList.add(first);
                element.classList.remove(second);
            } else {
                element.classList.add(second);
                window.setTimeout(function() {
                element.classList.remove(first);
                element.style.display = "";
                }, timeOfAnimation);
            }
            }
        
        document.addEventListener('keydown', (e) => {
            if (e.code === "Escape" && dlg.classList.contains("is-visible")) {
                toggleTwoClasses(dlg, "is-visible", "is-hidden", 500);
                dlg.close();
                dlg.style.display = "";

                 
            }
            });

        function showPopUp(msg) {
            toggleTwoClasses(popup, "is-visible", "is-hidden", 500);
            popup.showModal();
            popup_msgs.textContent = msg;
            // window.history.pushState(null, null, document.location);
            show = true;
        }

        // handleModalClick = ({ currentTarget, target }) => {
        //     const isClickedOnBackdrop = target === currentTarget;
        //     if (isClickedOnBackdrop) {
        //         toggleTwoClasses(popup, "is-visible", "is-hidden", 1000);
        //         popup.close();
        //         popup.style.display = "";
        //         // popup.style.display = "";
        //         // history.back();
        //         // show = false;
        //  }
        // }

        handleModalClick = (event) => {
            const modalRect = popup.getBoundingClientRect();

            if (
                event.clientX < modalRect.left ||
                event.clientX > modalRect.right ||
                event.clientY < modalRect.top ||
                event.clientY > modalRect.bottom
            ) {
                toggleTwoClasses(popup, "is-visible", "is-hidden", 300);
                popup.close();
                popup.style.display = "";
                // history.back();
                show = false;

            }
            };

        popup.addEventListener("click", handleModalClick);

        popup_button.addEventListener("click", () => {
            toggleTwoClasses(popup, "is-visible", "is-hidden", 500);
            popup.close();
            popup.style.display = "";
            // history.back();
            show = false;
            });

        addEventListener('popstate', function(e) {
            if (show) {
                popup.close();
                popup.style.display = "";
                dlg.close();
                dlg.style.display = "";
                dlg.classList.add("is-hidden");
                dlg.classList.remove("is-visible");
                popup.classList.add("is-hidden");
                popup.classList.remove("is-visible");
            
                // history.back();
                show = false;
            }
            })

        clsBtn.addEventListener("click", () => {
            toggleTwoClasses(dlg, "is-visible", "is-hidden", 500);
            
            
            // history.back();
            show = false;
            //dlg.close();
            });

        clsBtnNo.addEventListener("click", () => {
            toggleTwoClasses(dlg, "is-visible", "is-hidden", 500);
            
            
            // history.back();
            show = false;
            // dlg.close(); 
            });

        document.getElementById('bookings_list').addEventListener('htmx:confirm', function(evt) {
            if (evt.target.className === "unbook" || evt.target.className === "del"){
                evt.preventDefault();
                showMdAlrt(`${evt.detail.question}`);
                dlg.addEventListener("close", lstnr = () => {   
                    if (dlg.returnValue == "true") evt.detail.issueRequest(true);
                    dlg.removeEventListener("close", lstnr); 
                    })
               
            }})
            
        window.onLoad = function(){
            let dlg = undefined;
            let clsBtn = undefined; 
            let clsBtnNo = undefined; 
            let msgs = undefined;
            let popup = undefined;
            let popup_box = undefined;
            let popup_msgs = undefined;
            let popup_button = undefined;
            const handleModalClick = undefined;
            
        };
        
    </script>
</body>

</html>